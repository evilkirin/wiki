<!DOCTYPE HTML>
<html>
    <head>
        <link rel="Stylesheet" type="text/css" href="/static/css/typo.css">
        <link rel="Stylesheet" type="text/css" href="/static/css/reset_typo.css">
        <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
        <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
        <title>Read or Download a File from The Internet - Zach's not so private wiki</title>
        <meta name="keywords" content="java, frontend, backend, css, javascript"/>
        <meta name="description" content="you see the title.."/>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        
<script src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.js"></script>
<script language="javascript" type="text/javascript">
    var oddClick = true;
    $(document).ready(function() {
      $('#toggle-button').click(function() {
        $('#container').animate({
          width: oddClick? "100%":"60%",
        });
        $(this).text(oddClick? "窄版":"宽版");
        oddClick = !oddClick;
      });
    });
</script>

    </head>

    <body>
        <div id="container" class="typo">
            
    <div id="header">
        <div id="post-nav">
            <div id="toggle-button">宽版</div>
            
            <a href="/">Home</a> » <a href="/#java">java</a> » Read or Download a File from The Internet
            
        </div>
    </div>
    <div class="clearfix"></div>
    <div id="content">
        <p>最近老是和非本地的文件打交道，要不是读一个远程的资源文件的内容，就是将一个远程的资源弄到本地进行处理。这些远程资源都能够用一个URL来标示。</p>
<p>最稳妥功能最全面的肯定是HttpClient，但是纯粹为了这么一个基础的功能要去引入HttpClient还是有些心有不甘。特别是如果你还见过Groovy中GString的无比方便：</p>
<div class="hlcode"><pre><span class="kt">def</span> <span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;http://www.xxx.com/url.html&quot;</span><span class="o">.</span><span class="na">toURL</span><span class="o">().</span><span class="na">text</span>
</pre></div>


<p>我需要的是能够用尽量少的代码读取或者下载URL资源。Google一番之后，在一堆StackOverflow的问答中整理了一下答案。</p>
<h2 id="download">Download</h2>
<h3 id="java-nio">Java Nio</h3>
<div class="hlcode"><pre><span class="n">URL</span> <span class="n">website</span> <span class="o">=</span> <span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="s">&quot;http://www.website.com/information.asp&quot;</span><span class="o">);</span>
<span class="n">ReadableByteChannel</span> <span class="n">rbc</span> <span class="o">=</span> <span class="n">Channels</span><span class="o">.</span><span class="na">newChannel</span><span class="o">(</span><span class="n">website</span><span class="o">.</span><span class="na">openStream</span><span class="o">());</span>
<span class="n">FileOutputStream</span> <span class="n">fos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="s">&quot;information.html&quot;</span><span class="o">);</span>
<span class="n">fos</span><span class="o">.</span><span class="na">getChannel</span><span class="o">().</span><span class="na">transferFrom</span><span class="o">(</span><span class="n">rbc</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">Long</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">);</span>
</pre></div>


<p>并非最好的方式，因为transform方法无法保证一次能成功将文件的所有内容transform到目标stream。除此之外，这个场景下，zero-copy实际上并不生效。</p>
<blockquote>
<p>A single call isn't adequate. transferFrom() isnt' specified to complete the entire transfer in a single call. That's why it returns a count. You have to loop.</p>
<p>URL::openStream()returns just a regular stream, meaning the entire traffic is still being copied through Java byte[] arrays instead of remaining in native buffers. Only fos.getChannel()is actually a native channel, so the overhead remains in full. That's zero gains from using NIO in this case.</p>
</blockquote>
<h3 id="commons-io">Commons io</h3>
<div class="hlcode"><pre><span class="n">FileUtils</span><span class="o">.</span><span class="na">copyURLToFile</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">fileToBeDownloaded</span><span class="o">);</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">copyURLToFile</span><span class="o">(</span><span class="n">URL</span> <span class="n">source</span><span class="o">,</span> <span class="n">File</span> <span class="n">destination</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="n">InputStream</span> <span class="n">input</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="na">openStream</span><span class="o">();</span>
    <span class="n">copyInputStreamToFile</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">destination</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">copyInputStreamToFile</span><span class="o">(</span><span class="n">InputStream</span> <span class="n">source</span><span class="o">,</span> <span class="n">File</span> <span class="n">destination</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">FileOutputStream</span> <span class="n">output</span> <span class="o">=</span> <span class="n">openOutputStream</span><span class="o">(</span><span class="n">destination</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">IOUtils</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">source</span><span class="o">,</span> <span class="n">output</span><span class="o">);</span>
            <span class="n">output</span><span class="o">.</span><span class="na">close</span><span class="o">();</span> <span class="c1">// don&#39;t swallow close Exception if copy completes normally</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">IOUtils</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">IOUtils</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">copy</span><span class="o">(</span><span class="n">InputStream</span> <span class="n">input</span><span class="o">,</span> <span class="n">OutputStream</span> <span class="n">output</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="kt">long</span> <span class="n">count</span> <span class="o">=</span> <span class="n">copyLarge</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">output</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">count</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">DEFAULT_BUFFER_SIZE</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">4</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">long</span> <span class="nf">copyLarge</span><span class="o">(</span><span class="n">InputStream</span> <span class="n">input</span><span class="o">,</span> <span class="n">OutputStream</span> <span class="n">output</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">copyLarge</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">output</span><span class="o">,</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">DEFAULT_BUFFER_SIZE</span><span class="o">]);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">long</span> <span class="nf">copyLarge</span><span class="o">(</span><span class="n">InputStream</span> <span class="n">input</span><span class="o">,</span> <span class="n">OutputStream</span> <span class="n">output</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">buffer</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="kt">long</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">EOF</span> <span class="o">!=</span> <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">)))</span> <span class="o">{</span>
        <span class="n">output</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">n</span><span class="o">);</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="n">n</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">count</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>


<p>'The answer'.</p>
<h3 id="java-8">Java 8</h3>
<div class="hlcode"><pre><span class="n">URL</span> <span class="n">website</span> <span class="o">=</span> <span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="s">&quot;http://www.website.com/information.asp&quot;</span><span class="o">);</span>
<span class="k">try</span> <span class="o">(</span><span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="n">website</span><span class="o">.</span><span class="na">openStream</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">Files</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">in</span><span class="o">,</span> <span class="n">target</span><span class="o">,</span> <span class="n">StandardCopyOption</span><span class="o">.</span><span class="na">REPLACE_EXISTING</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>


<p>Preferred in Java 8.</p>
<h2 id="read-the-content">Read the Content</h2>
<h3 id="java-scanner">Java Scanner</h3>
<div class="hlcode"><pre><span class="c1">// The core part.</span>
<span class="n">String</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="s">&quot;http://www.google.com&quot;</span><span class="o">).</span><span class="na">openStream</span><span class="o">(),</span> <span class="s">&quot;UTF-8&quot;</span><span class="o">).</span><span class="na">useDelimiter</span><span class="o">(</span><span class="s">&quot;\\A&quot;</span><span class="o">).</span><span class="na">next</span><span class="o">();</span>

<span class="c1">// Complete version: http://stackoverflow.com/questions/4328711/read-url-to-string-in-few-lines-of-java-code#comment44940386_13632114</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">s</span><span class="o">(</span><span class="n">URL</span> <span class="n">u</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
    <span class="n">HttpURLConnection</span> <span class="n">c</span><span class="o">=</span><span class="kc">null</span><span class="o">;</span>
    <span class="n">InputStream</span> <span class="n">i</span><span class="o">=</span><span class="kc">null</span><span class="o">;</span>
    <span class="n">Scanner</span> <span class="n">s</span><span class="o">=</span><span class="kc">null</span><span class="o">;</span>
    <span class="k">try</span><span class="o">{</span>
        <span class="n">c</span><span class="o">=(</span><span class="n">HttpURLConnection</span><span class="o">)</span> <span class="n">u</span><span class="o">.</span><span class="na">openConnection</span><span class="o">();</span>
        <span class="c1">// 如果要设置超时，就只能先拿HttpURLConnection，再拿InputStream了</span>
        <span class="n">c</span><span class="o">.</span><span class="na">setConnectTimeout</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
        <span class="n">c</span><span class="o">.</span><span class="na">setReadTimeout</span><span class="o">(</span><span class="mi">25000</span><span class="o">);</span>
        <span class="n">i</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
        <span class="c1">// The regular expression \\A matches the beginning of input. This tells Scanner to tokenize the entire stream, from beginning to (illogical) next beginning. </span>
        <span class="n">s</span><span class="o">=</span><span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="n">i</span><span class="o">,</span><span class="s">&quot;UTF-8&quot;</span><span class="o">).</span><span class="na">useDelimiter</span><span class="o">(</span><span class="s">&quot;\\A&quot;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">hasNext</span><span class="o">()?</span><span class="n">s</span><span class="o">.</span><span class="na">next</span><span class="o">():</span><span class="s">&quot;&quot;</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="n">s</span><span class="o">!=</span><span class="kc">null</span><span class="o">)</span>
            <span class="n">s</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(</span><span class="n">i</span><span class="o">!=</span><span class="err">‌​</span><span class="kc">null</span><span class="o">)</span>
            <span class="k">try</span><span class="o">{</span>
                <span class="n">i</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span> <span class="err">‌​</span><span class="k">catch</span><span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">){}</span>
        <span class="k">if</span><span class="o">(</span><span class="n">c</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
            <span class="n">c</span><span class="o">.</span><span class="na">disconnect</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h3 id="commons-io_1">Commons io</h3>
<div class="hlcode"><pre><span class="n">IOUtils</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">URL</span> <span class="n">url</span><span class="o">,</span> <span class="n">String</span> <span class="n">encoding</span><span class="o">)</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">(</span><span class="n">URL</span> <span class="n">url</span><span class="o">,</span> <span class="n">Charset</span> <span class="n">encoding</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="n">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="na">openStream</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">toString</span><span class="o">(</span><span class="n">inputStream</span><span class="o">,</span> <span class="n">encoding</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">inputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">(</span><span class="n">InputStream</span> <span class="n">input</span><span class="o">,</span> <span class="n">Charset</span> <span class="n">encoding</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="n">StringBuilderWriter</span> <span class="n">sw</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilderWriter</span><span class="o">();</span>
    <span class="n">copy</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">sw</span><span class="o">,</span> <span class="n">encoding</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">sw</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">copy</span><span class="o">(</span><span class="n">InputStream</span> <span class="n">input</span><span class="o">,</span> <span class="n">Writer</span> <span class="n">output</span><span class="o">,</span> <span class="n">Charset</span> <span class="n">encoding</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="n">InputStreamReader</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InputStreamReader</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">Charsets</span><span class="o">.</span><span class="na">toCharset</span><span class="o">(</span><span class="n">encoding</span><span class="o">));</span>
    <span class="n">copy</span><span class="o">(</span><span class="n">in</span><span class="o">,</span> <span class="n">output</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>


<h3 id="java-8_1">Java 8</h3>
<div class="hlcode"><pre><span class="n">URLConnection</span> <span class="n">conn</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="na">openConnection</span><span class="o">();</span>
<span class="k">try</span> <span class="o">(</span><span class="n">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">InputStreamReader</span><span class="o">(</span><span class="n">conn</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">(),</span> <span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">)))</span> <span class="o">{</span>
    <span class="n">pageText</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">lines</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">joining</span><span class="o">(</span><span class="s">&quot;\n&quot;</span><span class="o">));</span>
<span class="o">}</span>
</pre></div>


<p>Preferred in Java 8.</p>
<h2 id="summary">Summary</h2>
<p>其实看下来，并没有什么特别的技巧，具体的实现基本就是标准答案。能用Commons就别再去费事儿写一遍了，除非你想练习练习基础。</p>
<p>不过，如果是正式项目，还是用HttpClient更稳妥一些。HttpClient还很方便地提供其他的一些功能，比如超时设置，302的支持，cookie的支持等。只要是请求涉及到http相关的一些额外处理，上边的方式都无法胜任了。</p>
<h3 id="refs">Refs</h3>
<ul>
<li><a href="http://stackoverflow.com/questions/921262/how-to-download-and-save-a-file-from-internet-using-java#comment729329_921400">How to download and save a file from Internet using Java? - Stack Overflow</a></li>
<li><a href="http://stackoverflow.com/questions/4328711/read-url-to-string-in-few-lines-of-java-code">http - Read url to string in few lines of java code - Stack Overflow</a></li>
<li><a href="http://stackoverflow.com/questions/6259339/how-to-read-a-text-file-directly-from-internet-using-java">How to read a text file directly from Internet using Java? - Stack Overflow</a></li>
</ul>
    </div>

        </div>
        <div id="footer">
              <p>
                Copyright © 2012-2016 Zach Tse.
                Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
                Theme by <a href="https://github.com/tankywoo/yasimple" target="_blank">YASimple</a>.
              </p>
                <p>Last Update 2016-10-16 17:03:16</p>
        </div>
    </body>
</html>